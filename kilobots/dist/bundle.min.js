!function(t){var e={};function i(a){if(e[a])return e[a].exports;var o=e[a]={i:a,l:!1,exports:{}};return t[a].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=t,i.c=e,i.d=function(t,e,a){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(a,o,function(e){return t[e]}.bind(null,o));return a},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);var a="339aa7dc8913ca519173b7daf8a3d4eaf08ca374";function o(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}var s=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.led={r:0,g:0,b:0},this._graphics_must_update=!0,this._uid=-1,this._startedAt=new Date,this._internalTicker=0,this._ambientlight=0,this._ambientlight_ready=0,this._faultiness=0}return function(t,e,i){e&&o(t.prototype,e)}(t,[{key:"get_ambientlight",value:function(){return this._ambientlight}},{key:"setFaultiness",value:function(t){this._faultiness=t}},{key:"setup",value:function(){}},{key:"loop",value:function(){}},{key:"_internal_loop",value:function(){this._internalTicker++}},{key:"kilo_init",value:function(){}},{key:"kilo_start",value:function(){console.error("Define 'loop()' and 'setup()' functions on this class")}},{key:"rand_soft",value:function(){return Math.floor(256*this._MathRandom())}},{key:"rand_hard",value:function(){return Math.floor(256*this._MathRandom())}},{key:"rand_seed",value:function(){}},{key:"_updated_graphics",value:function(){this._graphics_must_update=!1}},{key:"message_rx",value:function(){}},{key:"message_tx",value:function(){return null}},{key:"message_tx_success",value:function(){}},{key:"set_motors",value:function(t,e){if(t<0||255<t||e<0||255<e)console.error("left and right must be between 0 and 255, left is",t,e);else if(0!=t||0!=e){var i=1/this._LOOP_PER_SECOND*90*1,a=this._RADIUS*(25/16)*(1/this._LOOP_PER_SECOND)*1;this._faultiness;var o=this._phys.GetAngle(),s=o,r=this._phys.GetPosition(),n=new this._Box2D.b2Vec2(0,0);if(t==e&&t==this.kilo_straight_left&&t==this.kilo_straight_right)n.set_x(a*Math.cos(s*Math.PI/180)),n.set_y(a*Math.sin(s*Math.PI/180));else{var h=i*(e-t)/255;s+=h;var l,c=0,d=.9*this._RADIUS;l=t<e?(c=Math.cos(s*Math.PI/180+2*Math.PI/3)*d,Math.sin(s*Math.PI/180+2*Math.PI/3)*d):(c=Math.cos(s*Math.PI/180+4*Math.PI/3)*d,Math.sin(s*Math.PI/180+4*Math.PI/3)*d),n.set_x(c-c*Math.cos(h*Math.PI/180)+l*Math.sin(h*Math.PI/180)),n.set_y(l-c*Math.sin(h*Math.PI/180)-l*Math.cos(h*Math.PI/180))}n.set_x(1.75*n.get_x()*this._DAMPING*this._phys.GetMass()),n.set_y(1.75*n.get_y()*this._DAMPING*this._phys.GetMass()),this._phys.ApplyLinearImpulse(n,r,!0),this._phys.SetTransform(this._phys.GetPosition(),o+(s-o)),this._Box2D.destroy(n)}}},{key:"delay",value:function(){console.error("Delay ignored because delay is non-idiomatic Javascript. Instead, please use setTimeout, setInterval, Promise, etc.")}},{key:"spinup_motors",value:function(){}},{key:"mark",value:function(){this._mark||(this._mark=!0,this._graphics_must_update=!0)}},{key:"unmark",value:function(){this._mark&&(this._mark=!1,this._graphics_must_update=!0)}},{key:"RGB",value:function(t,e,i){return t<<4|e<<2|i<<0}},{key:"set_color",value:function(t){var e=(48&t)>>4,i=(12&t)>>2,a=(3&t)>>0;e==this.led.r&&i==this.led.g&&a==this.led.b||(this.led={r:e,g:i,b:a},this._graphics_must_update=!0)}},{key:"kilo_turn_left",get:function(){return 255}},{key:"kilo_turn_right",get:function(){return 255}},{key:"kilo_straight_left",get:function(){return 255}},{key:"kilo_straight_right",get:function(){return 255}},{key:"kilo_ticks",get:function(){return this._internalTicker}},{key:"kilo_uid",get:function(){return this._uid}}]),t}();function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function h(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}function l(){return{w:window.innerWidth,h:window.innerHeight}}function c(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}var d=11,u=1e3,p=16776960,y=!0,f=!1,g=function(){function t(e,i,a){r(this,t),this.Box2D=e,this.destroyFuncs=[],this.selectedUID=null,this.lightSources=[],this.connections=[],this.deltaTime=null,this.speedX=null,this.fps=60,this.metaData={},this.tickBatchCount=1,this.randomSeed=a,this.MathRandom=new Math.seedrandom(this.randomSeed),this.perfectStart=i,this.LayersOrder=["_Origin","_Shadow","_TraversedPath","_Robots","_LightSources","_Selection"],localStorage.setItem("V.ZOOM",1*Math.max(l().w,l().h)/120),localStorage.setItem("V.PAN.x",.5*l().w),localStorage.setItem("V.PAN.y",.5*l().h),this.V={PAN:{x:1*localStorage.getItem("V.PAN.x")||.5*l().w,y:1*localStorage.getItem("V.PAN.y")||.5*l().h},ZOOM:1*localStorage.getItem("V.ZOOM")||20}}return h(t,[{key:"setDrawConnsAndBounds",value:function(t){f=t}},{key:"setDrawShadow",value:function(t){y=t}},{key:"getLayersOrder",value:function(){return this.LayersOrder}},{key:"setLayersOrder",value:function(t){this.LayersOrder=t}},{key:"zIndexOf",value:function(t){var e=this.LayersOrder.indexOf(t);return-1==e&&console.error("name=".concat(t," not found in order list"),this.LayersOrder),e}},{key:"setDisplayedData",value:function(t,e,i){var a=this;if(i=Object.assign({graph:!1},i),null==e)delete this.metaData[t],this.metaGraphs[t]&&(this.metaGraphs[t].removeChildren(),this.metaContainer.removeChild(this.metaGraphs[t]),this.metaGraphs[t].destroy(!0),delete this.metaGraphs[t]);else if(i.graph)this.metaData[t]||(this.metaData[t]=[]),this.metaData[t].push(e),140<this.metaData[t].length&&(this.metaData[t]=this.metaData[t].slice(this.metaData[t].length-140,this.metaData[t].length));else{if(this.metaData[t]==e)return;this.metaData[t]=e}var o=Object.keys(this.metaData).filter((function(t){return!Array.isArray(a.metaData[t])})).sort().map((function(t){var e=a.metaData[t];if(Array.isArray(a.metaData[t])&&0<a.metaData[t].length){var i=a.metaData[t].length-1;e=a.metaData[t][i],e=Math.round(100*e)/100}return"".concat(t,": ").concat(e)})).join("\n"),s=new PIXI.TextMetrics.measureText(this.metaPixiText.text,this.metaPixiText.style),r=new PIXI.TextMetrics.measureText(o,this.metaPixiText.style),n=r.width;if(n<130&&(n=130),s.width!=n||s.lines.length!=r.lines.length||this.metaContainer.lastDarkMode!=this.darkMode){var h=r.lines.length;this.metaContainer.clear(),this.darkMode?(this.metaContainer.beginFill(0,.75),this.metaPixiText.style.fill=13421772):(this.metaContainer.beginFill(16777215,.75),this.metaPixiText.style.fill=0),this.metaContainer.drawRect(_.margin,_.margin,n+2*_.padding,_.lineHeight*h+2*_.padding),this.metaContainer.lastDarkMode=this.darkMode}this.metaPixiText.text=o,this.metaGraphs=this.metaGraphs||{};var l=r.height+1*_.margin+2*_.padding,c=n+2*_.padding;Object.keys(this.metaData).filter((function(t){return Array.isArray(a.metaData[t])})).sort().forEach((function(t,e){var i=a.metaData[t];if(a.metaGraphs[t])if(null==i)a.metaGraphs[t].removeChildren(),a.metaContainer.removeChild(a.metaGraphs[t]),a.metaGraphs[t].destroy(!0),delete a.metaGraphs[t];else{a.metaGraphs[t].clear(),a.metaGraphs[t].position.x=_.margin,a.metaGraphs[t].position.y=_.margin+l+e*(70+_.padding),a.metaGraphs[t].lineStyle(0),a.metaGraphs[t].beginFill(a.darkMode?0:16777215,.5),a.metaGraphs[t].drawRect(0,0,c,70);var o=c/140;o<1&&(o=1),a.metaGraphs[t].endFill();for(var s=Math.min.apply(null,a.metaData[t]),r=Math.max.apply(null,a.metaData[t]),n=null,h=0;h<a.metaData[t].length;h++){var d=c*(h+140-a.metaData[t].length)/140+.5*o,u=a.metaData[t][h],p=70-70*(u-s)/(r-s);a.metaGraphs[t].lineStyle(o,12074042,1),a.metaGraphs[t].moveTo(d,70),a.metaGraphs[t].lineTo(d,p),null!=n&&(n<u?(a.metaGraphs[t].lineStyle(o,3407718,.5),a.metaGraphs[t].moveTo(d,80),a.metaGraphs[t].lineTo(d,-10)):u<n&&(a.metaGraphs[t].lineStyle(o,16737843,.5),a.metaGraphs[t].moveTo(d,80),a.metaGraphs[t].lineTo(d,-10))),n=u}}else{a.metaGraphs[t]=new PIXI.Graphics;var y=new PIXI.Text(t,{fontSize:_.fontSize,align:"left",lineHeight:_.lineHeight,fill:a.darkMode?16777215:0});y.position={x:_.padding,y:_.padding},a.metaGraphs[t].addChild(y),a.metaContainer.addChild(a.metaGraphs[t])}}))}},{key:"destroy",value:function(){this.destroyFuncs.forEach((function(t){return t()}))}},{key:"forEachBody",value:function(t){for(var e=0;e<this.bodyIDs.length;e++){var i=this.bodyIDs[e];t(this.bodies[i],i,e)}}},{key:"setup",value:function(){var t=this;function e(e,i){e<2&&(e=2),40<e&&(e=40);var a=(t.V.PAN.x-i.x)/t.V.ZOOM,o=(t.V.PAN.y-i.y)/t.V.ZOOM;t.V.PAN.x+=a*e-a*t.V.ZOOM,t.V.PAN.y+=o*e-o*t.V.ZOOM,t.platformGraphics.position=t.V.PAN,t.V.ZOOM=e,localStorage.setItem("V.ZOOM",t.V.ZOOM),localStorage.setItem("V.PAN.x",t.V.PAN.x),localStorage.setItem("V.PAN.y",t.V.PAN.y)}function i(e){delete t.touches[e.data.pointerId],null!=t.pointerDownStart&&(t.pointerDownStart.x==e.data.global.x&&t.pointerDownStart.y==e.data.global.y&&(null!=t.selectedUID&&(t.bodies[t.selectedUID].robot._graphics_must_update=!0),t.selectedUID=null,t.experiment.clickedOutside&&t.experiment.clickedOutside()),t.clickArea.cursor="grab",t.pointerDownStart=null)}PIXI.utils.skipHello(),this.pixiApp=new PIXI.Application({backgroundColor:16777215,autoStart:!0,width:l().w,height:l().h,antialias:!0}),this.pixiApp.sortableChildren=!0,window.pixiApp=this.pixiApp,document.body.appendChild(this.pixiApp.view),this.pixiApp.view.addEventListener("mousewheel",(function(i){e(t.V.ZOOM*(1+i.wheelDelta/1e3),{x:i.clientX,y:i.clientY})})),this.clickArea=new PIXI.Container,this.clickArea.interactive=!0,this.clickArea.cursor="grab",this.clickArea.hitArea=new PIXI.Rectangle(0,0,l().w,l().h),this.pixiApp.stage.addChild(this.clickArea),this.touches={},this.clickArea.on("pointerdown",(function(e){t.touches[e.data.pointerId]={p1:{x:e.data.global.x,y:e.data.global.y,zoomBeforePinch:t.V.ZOOM},p2:{x:e.data.global.x,y:e.data.global.y}},t.clickArea.cursor="grabbing",t.pointerDownStart={x:e.data.global.x,y:e.data.global.y,panX:t.V.PAN.x,panY:t.V.PAN.y},e.stopPropagation()})),this.clickArea.on("pointerup",i),this.clickArea.on("pointerupoutside",i),this.clickArea.on("pointercancel",i),this.clickArea.on("pointerout",i),this.clickArea.on("pointermove",(function(i){if(2==Object.keys(t.touches).length){var a=i.data.pointerId,o=Object.keys(t.touches).filter((function(t){return t!=a}))[0];if(!o)return void console.error("the other touch ID was not found");var s=t.touches[o],r=t.touches[a];r.p2={x:i.data.global.x,y:i.data.global.y};var n=Math.round(c(s.p1,r.p1)),h=Math.round(c(s.p2,r.p2)),l={x:(s.p2.x+r.p2.x)/2,y:(s.p2.y+r.p2.y)/2};return 0==n&&(n=1),void e(s.p1.zoomBeforePinch*h/n,l)}t.pointerDownStart&&(t.touches[i.data.pointerId]={p1:{x:i.data.global.x,y:i.data.global.y,zoomBeforePinch:t.V.ZOOM},p2:{x:i.data.global.x,y:i.data.global.y}},t.V.PAN.x=t.pointerDownStart.panX+(i.data.global.x-t.pointerDownStart.x),t.V.PAN.y=t.pointerDownStart.panY+(i.data.global.y-t.pointerDownStart.y),localStorage.setItem("V.PAN.x",t.V.PAN.x),localStorage.setItem("V.PAN.y",t.V.PAN.y),t.platformGraphics.position=t.V.PAN)})),this.clickArea.on("touchend",i),this.clickArea.on("touchcancel",i),this.platformGraphics=new PIXI.Container,this.platformGraphics.zIndex=1,this.platformGraphics.position=this.V.PAN,this.platformGraphics.sortableChildren=!0,this.pixiApp.stage.addChild(this.platformGraphics),this.metaContainer=new PIXI.Graphics,this.metaContainer.zIndex=2,this.metaPixiText=new PIXI.Text("",{fontSize:_.fontSize,align:"left",lineHeight:_.lineHeight,fill:this.darkMode?16777215:0}),this.metaPixiText.position={x:_.margin+_.padding,y:_.margin+_.padding},this.metaContainer.addChild(this.metaPixiText),this.pixiApp.stage.addChild(this.metaContainer);var a=new PIXI.Graphics;a.zIndex=this.zIndexOf("_TraversedPath"),a.alpha=.3,a.endFill(),this.platformGraphics.addChild(a),this.pixiApp.ticker.add((function(){a.clear(),t.experiment.runnerOptions.traversedPath&&t.forEachBody((function(e){a.lineStyle(2,w(e.robot.led));var i=null,o=null,s=e.posHistoryX.length,r=0,n=e.posHistoryCursor;e.posHistoryFilled&&(r=(e.posHistoryCursor+1)%s,n=e.posHistoryCursor);for(var h=0,l=r;l%s!=n;l++){h+=1/s;var c=l%s,d=e.posHistoryX[c],u=e.posHistoryY[c],p=e.posHistoryColor[c];e.posHistoryAngle[c],null!=i?(a.lineStyle(1*h*t.V.ZOOM,p),a.moveTo(i*t.V.ZOOM,o*t.V.ZOOM),a.lineTo(d*t.V.ZOOM,u*t.V.ZOOM),i=d,o=u,a.moveTo(d*t.V.ZOOM,u*t.V.ZOOM)):(i=d,o=u,a.moveTo(d*t.V.ZOOM,u*t.V.ZOOM))}null!=i&&(a.lineStyle(1*h*t.V.ZOOM,I(e.robot.led)),a.lineTo(e.body.GetPosition().get_x()*t.V.ZOOM,e.body.GetPosition().get_y()*t.V.ZOOM))}))}));var o=new PIXI.Graphics;o.alpha=.75,o.lastLightSources=JSON.stringify(this.lightSources),this.platformGraphics.addChild(o),this.pixiApp.ticker.add((function(){o.lastLightSources!=JSON.stringify(t.lightSources)&&(o.clear(),o.zIndex=t.zIndexOf("_LightSources"),o.beginFill(p,1),t.lightSources.forEach((function(e){for(var i=0;i<6;i++)o.lineStyle(.5*t.V.ZOOM,p),o.moveTo((e.pos.x-2*Math.cos(i/6*Math.PI))*t.V.ZOOM,(e.pos.y-2*Math.sin(i/6*Math.PI))*t.V.ZOOM),o.lineTo((e.pos.x+2*Math.cos(i/6*Math.PI))*t.V.ZOOM,(e.pos.y+2*Math.sin(i/6*Math.PI))*t.V.ZOOM)})))}));var s=new PIXI.Graphics;if(s.zIndex=this.zIndexOf("_Selection"),s.alpha=.9,this.platformGraphics.addChild(s),this.pixiApp.ticker.add((function(){if(s.clear(),t.selectedUID){var e=t.bodies[t.selectedUID],i=e.position;if(!e.position&&e.getData){var a=e.getData();i=a.pos,a.angle}s.lineStyle(.5*t.V.ZOOM,12074042,1);for(var o=0;o<2*Math.PI;){var r=2*e.circleRadius;s.moveTo((i.x+Math.cos(o)*r)*t.V.ZOOM,(i.y+Math.sin(o)*r)*t.V.ZOOM),o+=2*Math.PI*1/8*.25,s.lineTo((i.x+Math.cos(o)*r)*t.V.ZOOM,(i.y+Math.sin(o)*r)*t.V.ZOOM),o+=2*Math.PI*1/8*.25}}})),y){var r=new PIXI.Graphics;r.zIndex=this.zIndexOf("_Shadow"),r.alpha=.25,r.graphicShadoes={},this.platformGraphics.addChild(r),this.pixiApp.ticker.add((function(){0==r.children.length&&t.forEachBody((function(e){t.lightSources.forEach((function(t,i){var a=new PIXI.Graphics,o="".concat(e.robot._uid,":").concat(i);a.beginFill(0,1),a.drawCircle(0,0,e.circleRadius),r.graphicShadoes[o]=a,r.addChild(a)}))})),t.forEachBody((function(e){t.lightSources.forEach((function(i,a){var o="".concat(e.robot._uid,":").concat(a),s=r.graphicShadoes[o],n=e.body.GetPosition().get_x(),h=e.body.GetPosition().get_y(),l=n-i.pos.x,c=h-i.pos.y,d=Math.sqrt(l*l+c*c);d<1&&(d=1);var u=.1*d;u<1?u=1:1e3<u&&(u=1e3),s.scale.x=u*t.V.ZOOM,s.scale.y=t.V.ZOOM,s.angle=180*Math.atan(c/l)/Math.PI,s.alpha=2/u;var p=u*e.circleRadius*t.V.ZOOM;s.position.x=n*t.V.ZOOM+l/d*p-l/d*e.circleRadius*t.V.ZOOM,s.position.y=h*t.V.ZOOM+c/d*p-c/d*e.circleRadius*t.V.ZOOM}))}))}))}if(f){var n=new PIXI.Graphics;n.zIndex=this.zIndexOf("ConnsAndBouns"),n.alpha=.5,platformGraphics.addChild(n),pixiApp.ticker.add((function(){if(n.clear(),f){for(var e=[],i=0;i<bodyIDs.length;i++)if(null==t.selectedUID||t.selectedUID==bodyIDs[i])for(var a=bodies[bodyIDs[i]].body.GetFixtureList(),o=Box2D.getPointer(a),s=0;o;)s++,e.push({aabb:a.GetAABB(),color:s%2==0?65280:255}),a=a.GetNext(),o=Box2D.getPointer(a);e.forEach((function(e){n.lineStyle(2,e.color||65280),n.drawRect(t.V.ZOOM*e.aabb.get_lowerBound().get_x(),t.V.ZOOM*e.aabb.get_lowerBound().get_y(),t.V.ZOOM*(e.aabb.get_upperBound().get_x()-e.aabb.get_lowerBound().get_x()),t.V.ZOOM*(e.aabb.get_upperBound().get_y()-e.aabb.get_lowerBound().get_y()))}))}}))}this.destroyFuncs.push((function(){return t.pixiApp.ticker.update()})),this.destroyFuncs.push((function(){return t.pixiApp.destroy()})),this.physics=new m(this.Box2D,this.MathRandom),this.destroyFuncs.push((function(){return t.physics.destroy()}))}},{key:"run",value:function(t){var e=this;this.setup(),this.bodies={},this.experiment=t,this.experiment.runnerOptions=Object.assign({limitSpeed:!1,traversedPath:!1,traversedPathLen:20,darkMode:!1,selectedUID:null},this.experiment.runnerOptions),this.darkMode=this.experiment.runnerOptions.darkMode,this.pixiApp.renderer.backgroundColor=this.darkMode?1118481:15658734,this.selectedUID=this.experiment.runnerOptions.selectedUID,this.experiment.V=this.V,this.experiment.equalZooms=v,this.experiment.copyView=M;var i=0;t.createRobots((function(t,a,o){i++;var s=e.physics.circle(t,a,1,i);s.robot=o,s.robot._uid=i,s.robot._phys=s.body,s.robot._Box2D=e.Box2D,s.robot._MathRandom=e.MathRandom,s.robot._RADIUS=1,s.robot._DAMPING=u,s.robot._LOOP_PER_SECOND=30,e.bodies[s.robot._uid]=s,e.createBodyGraphic(s)}),(function(t){e.lightSources.push({pos:t})}),1,d,15),window.bodies=this.bodies;var a=Object.keys(this.bodies),o=new ArrayBuffer(a.length*Int32Array.BYTES_PER_ELEMENT);this.bodyIDs=new Int32Array(o);for(var s=0;s<a.length;s++)this.bodyIDs[s]=a[s];var r=new ArrayBuffer(this.bodyIDs.length*Int8Array.BYTES_PER_ELEMENT);this.bodyRobotIsStarted=new Int8Array(r);for(var n=0;n<this.bodyRobotIsStarted.length;n++)this.bodyRobotIsStarted[n]=0;this.experiment.setupGraphics&&this.experiment.setupGraphics(PIXI,Box2D,this.pixiApp,this.platformGraphics,this.bodies,this.bodyIDs,this.setDisplayedData.bind(this),this.zIndexOf.bind(this),this.V),this.perfectStart&&this.forEachBody((function(t){t.robot.setup(),t.robot._started=!0})),this.setDisplayedData("Count","".concat(this.bodyIDs.length," ").concat(1==this.bodyIDs.length?"robot":"robots")),this.setDisplayedData("Random seed","".concat(this.randomSeed)),this.setDisplayedData("Version","".concat(VERSION.substr(0,8))),console.log(VERSION),this.aabb=new this.Box2D.b2AABB,this.lowerBound=new this.Box2D.b2Vec2(0,0),this.upperBound=new this.Box2D.b2Vec2(0,0),this.queryCallback=new this.Box2D.JSQueryCallback,this.queryCallback.ReportFixture=function(t){var e=this.Box2D.wrapPointer(t,this.Box2D.b2Fixture).GetBody().GetUserData();return 0==e||h(this.broadcastingBody,e,this.message),!0};var h=function(t,i,a){if(i!=t.body.GetUserData()){var o=e.bodies[i];if(o){if(o.robot._started){var s=t.body.GetPosition(),r=o.body.GetPosition(),n=D(s,r);d<n||(o.robot.message_rx(a,n),f&&e.connections.push({from:t.body.GetUserData(),to:o.body.GetUserData()}))}}else console.error("body id not found id=".concat(i))}};return new Promise((function(t,i){e.startDate=performance.now(),e.frameCount=-1,e.tickFunc(!0)}))}},{key:"tickFunc",value:function(t){var e=this;if(!this.paused)if(null==this.playUntil||this.frameCount!=this.playUntil){if(!window._state_stop){this.frameCount++;var i=Math.floor(this.frameCount/30),a=(performance.now(),this.startDate,this.tickBatchCount*(this.fps/30));if(null==this.speedX?this.speedX=a:this.speedX+=(a-this.speedX)*(1/120),this.setDisplayedData("Duration","".concat(x(i,!0))),this.setDisplayedData("Simulation speed","".concat(2<this.speedX?Math.round(this.speedX):Math.round(10*this.speedX)/10,"x")),this.selectedUID?(this.setDisplayedData("[Selected] ID",this.selectedUID),this.bodies[this.selectedUID].robot._ambientlight_ready&&this.setDisplayedData("[Selected] Ambient Light",this.bodies[this.selectedUID].robot._ambientlight,{graph:!0})):(this.setDisplayedData("[Selected] ID",null),this.setDisplayedData("[Selected] Ambient Light",null,{graph:!0})),this.physics.update(),this.experiment.runnerOptions.traversedPath&&this.frameCount%(this.experiment.runnerOptions.limitSpeed?10:30)==0){var o=this.experiment.runnerOptions.traversedPathLen;this.forEachBody((function(t){null==t.posHistoryX&&(t.posHistoryCursor=-1,t.posHistoryFilled=!1,t.posHistoryX=new Float64Array(o),t.posHistoryY=new Float64Array(o),t.posHistoryAngle=new Float64Array(o),t.posHistoryColor=new Array);var e=t.body.GetPosition(),i={x:e.get_x(),y:e.get_y(),angle:t.body.GetAngle()};t.posHistoryCursor==o-1&&(t.posHistoryFilled=!0),t.posHistoryCursor=(t.posHistoryCursor+1)%o,t.posHistoryX[t.posHistoryCursor]=i.x,t.posHistoryY[t.posHistoryCursor]=i.y,t.posHistoryAngle[t.posHistoryCursor]=i.angle,t.posHistoryColor[t.posHistoryCursor]=I(t.robot.led)}))}for(var s=0;s<this.bodyIDs.length;s++){var r=this.bodies[this.bodyIDs[s]].robot;r._started?(r.loop(),r._internal_loop()):this.MathRandom()<.75&&(r.setup(),r._started=!0)}if(this.connections=[],0<this.lightSources.length)for(var n=function(t){var i=e.bodies[e.bodyIDs[t]];if(e.frameCount<i.lastAmbientLightSetAt+5)return"continue";var a=10240*e.lightSources.length;e.lightSources.forEach((function(t){var e=i.body.GetPosition().get_x(),o=i.body.GetPosition().get_y(),s=e-t.pos.x,r=o-t.pos.y,n=Math.sqrt(s*s+r*r);a-=10*n})),.9<e.MathRandom()&&(a+=5*(e.MathRandom()-.5)),i.lastAmbientLightSetAt=e.frameCount;var o=0|a;o<0|0&&(o=0),i.robot._ambientlight=0|o,i.robot._ambientlight_ready=1},h=0;h<this.bodyIDs.length;h++)n(h);for(var l=0;l<this.bodyIDs.length;l++){var c=this.bodies[this.bodyIDs[l]];if(!(this.frameCount<c.lastMessageSentAt+15)){c.lastMessageSentAt=this.frameCount-Math.floor(2*this.MathRandom());var u=c;if(u){if(u.robot._started){var p=u.robot.message_tx();if(null!=(p=JSON.parse(JSON.stringify(p)))){u.robot.message_tx_success();var y=u.body.GetPosition().get_x(),f=u.body.GetPosition().get_y();this.lowerBound.set_x(y-d),this.lowerBound.set_y(f-d),this.upperBound.set_x(y+d),this.upperBound.set_y(f+d),this.aabb.set_lowerBound(this.lowerBound),this.aabb.set_upperBound(this.upperBound),this.queryCallback.message=p,this.queryCallback.broadcastingBody=u,this.queryCallback.Box2D=this.Box2D,this.physics.world.QueryAABB(this.queryCallback,this.aabb)}}}else console.error("deleted robot fetched")}}if(t){var g=performance.now();window.requestAnimationFrame((function(){return function(){for(var t=0;t<e.tickBatchCount-1;t++)e.tickFunc(!1);e.tickFunc(!0);var i=(performance.now()-g)/1e3;null==e.deltaTime?e.deltaTime=i:e.deltaTime+=.2*(i-e.deltaTime),0==e.deltaTime?e.fps=60:e.fps=1/e.deltaTime,55<e.fps?e.tickBatchCount+=.2:e.tickBatchCount-=1,e.tickBatchCount<1&&(e.tickBatchCount=1),e.experiment.runnerOptions.limitSpeed&&(e.tickBatchCount=1)}()}))}}}else this.paused=!0}},{key:"toggleLimitSpeed",value:function(){this.experiment.runnerOptions.limitSpeed=!this.experiment.runnerOptions.limitSpeed}},{key:"doTick",value:function(t){this.paused=!1,this.tickBatchCount=1,this.playUntil=this.frameCount+1+(t||1),this.tickFunc(!0)}},{key:"togglePause",value:function(){this.paused=!this.paused,this.playUntil=null,this.paused?this.tickBatchCount=1:this.tickFunc(!0)}},{key:"createBodyGraphic",value:function(t){var e=this;switch(t.label){case"Circle Body":var i=new PIXI.Graphics;i.lastView=null,(t.g=i).on("pointerdown",(function(i){null!=e.selectedUID&&(e.bodies[e.selectedUID].robot._graphics_must_update=!0),e.selectedUID=t.robot._uid,t.robot._graphics_must_update=!0}));this.pixiApp.ticker.add((function(){!function(t){var a=t.position,o=0;if(!t.position&&t.getData){var s=t.getData();a=s.pos,o=s.angle}if(i.x=a.x*e.V.ZOOM,i.y=a.y*e.V.ZOOM,i.angle=o,i.zIndex=e.zIndexOf("_Robots"),v(i.lastView,e.V)){if(!t.robot._graphics_must_update)return;t.robot._updated_graphics()}i.lastView=M(e.V),i.clear(),i.removeChildren();var r=0;if(e.darkMode?i.beginFill(0):(r=1,i.lineStyle(r,w(t.robot.led),.5),i.beginFill(16777215)),i.drawCircle(0,0,t.circleRadius*e.V.ZOOM-r/2),i.lineStyle(0),e.darkMode){i.beginFill(I(t.robot.led),.4);var n=t.circleRadius*e.V.ZOOM-r/2;i.drawCircle(0,0,n)}else{i.beginFill(I(t.robot.led),.2);var h=t.circleRadius*e.V.ZOOM-r/2;i.drawCircle(0,0,h)}if(10<e.V.ZOOM*t.circleRadius&&(i.endFill(),i.lineStyle(t.circleRadius*e.V.ZOOM*.25,0,1),i.moveTo(0,0),i.lineTo(t.circleRadius*e.V.ZOOM-r,0)),10<e.V.ZOOM*t.circleRadius){i.beginFill(0,1),i.lineStyle(0);var l=t.circleRadius*e.V.ZOOM*.15,c=t.circleRadius*e.V.ZOOM-l;[2/3*Math.PI,4/3*Math.PI].forEach((function(t){i.drawCircle(c*Math.cos(t),c*Math.sin(t),l)}))}var d=.4*t.circleRadius*e.V.ZOOM;i.lineStyle(2,0,.3),e.darkMode,i.beginFill(I(t.robot.led)),i.drawCircle(0,0,d)}(t)})),this.platformGraphics.addChild(i)}}}]),t}(),m=function(){function t(e,i){r(this,t),this.Box2D=e,this.MathRandom=i,this.currentFrame=0,this.destroyFuncs=[];var a=new this.Box2D.b2Vec2(0,0);this.world=new this.Box2D.b2World(a),window.world=this.world,(new this.Box2D.b2PolygonShape).SetAsBox(100,100);var o=new this.Box2D.b2BodyDef;o.set_type(this.Box2D.b2_staticBody),this.surfaceBody=this.world.CreateBody(o),this.zero=new this.Box2D.b2Vec2(0,0)}return h(t,[{key:"edgeShape",value:function(t,e){var i=new this.Box2D.b2BodyDef;i.set_type(this.Box2D.b2_staticBody);var a=this.world.CreateBody(i);a.SetUserData(0);var o=new this.Box2D.b2EdgeShape;o.Set(new this.Box2D.b2Vec2(t.x,t.y),new this.Box2D.b2Vec2(e.x,e.y)),a.CreateFixture(o,0)}},{key:"destroy",value:function(){this.destroyFuncs.forEach((function(t){return t()}))}},{key:"update",value:function(){this.world.Step(1/60,8,3),this.currentFrame++}},{key:"circle",value:function(t,e,i,a){var o=new this.Box2D.b2BodyDef;o.set_linearDamping(u),o.set_angularDamping(u),o.set_type(this.Box2D.b2_dynamicBody);var s=new this.Box2D.b2Vec2(t.x,t.y);o.set_position(s),this.Box2D.destroy(s),o.set_bullet(!1);var r=new this.Box2D.b2Filter;r.set_categoryBits(O.ROBOT),r.set_maskBits(O.ROBOT|O.NEIGHBOR),this.circleShape||(this.circleShape=new this.Box2D.b2CircleShape,this.circleShape.set_m_radius(i));var n=new this.Box2D.b2FixtureDef;n.set_density(1),n.set_friction(10),n.set_restitution(0),n.set_shape(this.circleShape),n.set_filter(r),this.Box2D.destroy(r);var h=this.world.CreateBody(o);h.CreateFixture(n);var l=new this.Box2D.b2FrictionJointDef;return l.Initialize(h,this.surfaceBody,this.zero),l.set_localAnchorA(this.zero),l.set_localAnchorB(this.zero),l.set_maxForce(400),this.world.CreateJoint(l),this.Box2D.destroy(l),h.SetUserData(a),h.SetTransform(h.GetPosition(),180*e/Math.PI),new b(h,i,this.MathRandom)}}]),t}(),b=function(){function t(e,i,a){r(this,t),this.body=e,this.label="Circle Body",this.circleRadius=i,this.posHistoryCursor=null,this.posHistoryFilled=!1,this.posHistoryX=null,this.posHistoryY=null,this.posHistoryAngle=null,this.lastMessageSentAt=Math.floor(60*a()),this.lastAmbientLightSetAt=Math.floor(60*a())}return h(t,[{key:"getData",value:function(){var t=this.body.GetPosition();return{angle:this.body.GetAngle(),pos:{x:t.get_x(),y:t.get_y()}}}}]),t}(),x=function(t,e){var i=Math.floor(t/3600),a=Math.floor((t-3600*i)/60),o=Math.floor(t%60);return o<10&&(o="0".concat(o)),a<10&&(a="0".concat(a)),i<10&&(i="0".concat(i)),e||0<i?"".concat(i,":").concat(a,":").concat(o):0<a?"".concat(a,"m:").concat(o,"s"):"".concat(o,"s")},_={fontSize:12,lineHeight:20,padding:20,margin:20},O={NONE:0,ROBOT:1,NEIGHBOR:2},v=function(t,e){return null!=t&&null!=e&&t.ZOOM==e.ZOOM},M=function(t){return{PAN:{x:t.PAN.x,y:t.PAN.y},ZOOM:t.ZOOM}},D=function(t,e){return Math.sqrt(Math.pow(t.get_x()-e.get_x(),2)+Math.pow(t.get_y()-e.get_y(),2))};function I(t){var e=Math.floor(255*t.r/3).toString(16),i=Math.floor(255*t.g/3).toString(16),a=Math.floor(255*t.b/3).toString(16);return 1==e.length&&(e="0".concat(e)),1==i.length&&(i="0".concat(i)),1==a.length&&(a="0".concat(a)),"0x".concat(e).concat(i).concat(a)}function w(t){var e=Math.floor(255*t.r/3/2).toString(16),i=Math.floor(255*t.g/3/2).toString(16),a=Math.floor(255*t.b/3/2).toString(16);return 1==e.length&&(e="0".concat(e)),1==i.length&&(i="0".concat(i)),1==a.length&&(a="0".concat(a)),"0x".concat(e).concat(i).concat(a)}window.VERSION=a,window.Kilobot=s,window.Pitch=g,console.log("VERSION is",a)}]);
//# sourceMappingURL=bundle.min.js.map